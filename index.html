<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RJ VideoCall ‚Äî /room/1008</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  :root{--accent:#0095f6;}
  html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#f09433,#e6683c,#dc2743);-webkit-font-smoothing:antialiased;}
  .wrap{max-width:980px;margin:10px auto;padding:12px;box-sizing:border-box;}
  .card{background:rgba(255,255,255,0.97);border-radius:12px;padding:12px;color:#111;box-shadow:0 4px 20px rgba(0,0,0,0.12)}
  .header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:10px;}
  .header h2{margin:0;font-size:18px}
  .row{display:flex;gap:8px;align-items:center}
  input[type="text"], input[type="number"]{padding:10px;border-radius:8px;border:1px solid #ddd;flex:1}
  button{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer;font-weight:600}

  /* video area */
  .video-wrap{position:relative;margin-top:10px;height:60vh;border-radius:10px;overflow:hidden;background:#000;}
  #remoteVideo{width:100%;height:100%;object-fit:cover;background:#000;}
  #localVideo{
    position:absolute;width:120px;height:160px;border-radius:10px;right:14px;bottom:120px;border:2px solid rgba(255,255,255,0.95);
    background:#000;z-index:40;object-fit:cover;cursor:pointer;touch-action:none;transition:all .18s ease;}
  #localVideo.min{ width:84px;height:112px;}
  #remoteVideo.small{ position:absolute; right:14px; bottom:120px; width:140px; height:190px; z-index:30; border-radius:10px; border:2px solid rgba(255,255,255,0.9); object-fit:cover; }

  .controls{display:flex;justify-content:center;gap:10px;margin-top:10px}
  .controls button{flex:0 0 120px;padding:10px;border-radius:999px;background:rgba(0,0,0,0.6);color:#fff}

  /* chat */
  .chat{margin-top:12px;background:rgba(255,255,255,0.98);border-radius:10px;padding:8px;display:flex;flex-direction:column;height:28vh}
  .messages{flex:1;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:8px}
  .msg{max-width:72%;padding:8px;border-radius:10px;background:#f1f1f1;color:#111}
  .msg.sent{align-self:flex-end;background:#dcf8c6}
  .chat-input{display:flex;gap:8px;margin-top:8px;align-items:center}
  .chat-input input[type="text"]{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd}
  .file-btn{padding:8px 10px;border-radius:8px;background:var(--accent);color:#fff;cursor:pointer}
  .note{font-size:12px;color:#666;margin-top:6px}

  @media(max-width:720px){
    .video-wrap{height:55vh}
    #localVideo{right:8px;bottom:100px}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <h2>Call ‚Äî Room format: <code>/room/1008</code></h2>
      <div style="font-size:12px;color:#555">Max 2 users ‚Äî PIN = 1008</div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <input id="pinInput" type="text" placeholder="PIN (1008)" style="width:120px" value="1008" readonly>
      <button id="hostBtn">Host</button>
      <button id="joinBtn">Join</button>
      <input id="hostPeerInput" type="text" placeholder="(optional) paste host peer id" style="width:260px">
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <input id="roomLink" type="text" placeholder="Room link will appear here" readonly>
      <button id="copyLinkBtn">Copy Link</button>
    </div>

    <div class="video-wrap" id="videoWrap">
      <video id="remoteVideo" autoplay playsinline></video>
      <video id="localVideo" autoplay muted playsinline></video>
    </div>

    <div class="controls">
      <button id="muteBtn">üé§ Mute</button>
      <button id="switchBtn">üîÑ Switch</button>
      <button id="speakerBtn">üîä Speaker</button>
      <button id="endBtn" style="background:#ff3b30">‚ùå End</button>
    </div>

    <div class="chat">
      <div class="messages" id="messages"></div>
      <div class="chat-input">
        <input id="textInput" type="text" placeholder="Type a message...">
        <label class="file-btn">üìé<input id="fileInput" type="file" accept="image/*,video/*" style="display:none"></label>
        <button id="sendBtn" style="background:var(--accent);color:#fff">Send</button>
      </div>
      <div class="note">Files limited to 6 MB. For larger files use Storage.</div>
    </div>
  </div>
</div>

<script>
/* =============== Firebase config (your project) =============== */
const firebaseConfig = {
  apiKey: "AIzaSyCdaMeWKKI7P8_sNeVbjs4eRlnufQItlJI",
  authDomain: "video-call-a9749.firebaseapp.com",
  projectId: "video-call-a9749",
  storageBucket: "video-call-a9749.firebasestorage.app",
  messagingSenderId: "655086083238",
  appId: "1:655086083238:web:ec14414fb08712aa696867",
  measurementId: "G-4KR499NMHS"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* =============== UI elements =============== */
const pinInput = document.getElementById('pinInput');
const hostBtn = document.getElementById('hostBtn');
const joinBtn = document.getElementById('joinBtn');
const hostPeerInput = document.getElementById('hostPeerInput');
const roomLinkInput = document.getElementById('roomLink');
const copyLinkBtn = document.getElementById('copyLinkBtn');

const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');

const muteBtn = document.getElementById('muteBtn');
const switchBtn = document.getElementById('switchBtn');
const speakerBtn = document.getElementById('speakerBtn');
const endBtn = document.getElementById('endBtn');

const messagesDiv = document.getElementById('messages');
const textInput = document.getElementById('textInput');
const fileInput = document.getElementById('fileInput');
const sendBtn = document.getElementById('sendBtn');

/* =============== state =============== */
let localStream = null;
let pc = null;
let roomId = null;
let roomRef = null;
let isHost = false;
let connected = false;
let listenRefs = [];
let facing = 'user';
let speakerOn = true;
let muted = false;

/* =============== helper: messages =============== */
function addMessage(content, sent=false, fileType=null){
  const el = document.createElement('div');
  el.className = 'msg ' + (sent ? 'sent' : 'received');
  if(fileType){
    if(fileType.startsWith('image')){
      const img = document.createElement('img'); img.src = content; img.style.maxWidth='220px'; img.style.borderRadius='8px';
      el.appendChild(img);
    } else if(fileType.startsWith('video')){
      const v = document.createElement('video'); v.src = content; v.controls = true; v.style.maxWidth='220px'; v.style.borderRadius='8px';
      el.appendChild(v);
    } else { el.textContent = '[file]'; }
  } else {
    el.textContent = content;
  }
  messagesDiv.appendChild(el);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/* =============== URL helpers =============== */
function extractRoomFromPath(){
  const parts = window.location.pathname.split('/').filter(Boolean);
  for(let i=0;i<parts.length-0;i++){
    if(parts[i].toLowerCase()==='room' && parts[i+1]) return parts[i+1];
  }
  return null;
}
function makeRoomLink(id){
  let base = location.origin + location.pathname;
  base = base.replace(/index\.html$/,'').replace(/\/$/,'');
  return base + '/room/' + encodeURIComponent(id);
}

/* =============== start local media =============== */
async function startLocalMedia(mode='user'){
  try{
    const constraints = {
      audio: true,
      video: { facingMode: mode, width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30 } }
    };
    const s = await navigator.mediaDevices.getUserMedia(constraints);
    localStream = s;
    localVideo.srcObject = s;
    return s;
  }catch(err){
    console.error('getUserMedia error', err);
    alert('Camera/Mic access required: ' + (err.message||err));
    throw err;
  }
}

/* =============== create RTCPeerConnection =============== */
function createPeerConnection(){
  const config = {
    iceServers: [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:global.stun.twilio.com:3478' },
      { urls: 'stun:stun1.l.google.com:19302' }
    ]
  };
  const _pc = new RTCPeerConnection(config);

  if(localStream) localStream.getTracks().forEach(t => _pc.addTrack(t, localStream));

  _pc.ontrack = e => {
    remoteVideo.srcObject = e.streams[0];
    // try to set receiver preferences or do nothing
  };

  _pc.onicecandidate = e => {
    if(e.candidate && roomRef){
      const obj = { from: isHost ? 'host' : 'guest', candidate: e.candidate.toJSON(), ts: Date.now() };
      roomRef.child('candidates').push(obj).catch(console.error);
    }
  };

  _pc.onconnectionstatechange = () => {
    console.log('pc state', _pc.connectionState);
    if(_pc.connectionState === 'connected') connected = true;
    if(_pc.connectionState === 'disconnected' || _pc.connectionState==='failed'){
      console.warn('PeerConnection state:', _pc.connectionState);
    }
  };

  // attempt to set sender encoding (bitrate) for smoother video
  _pc.onnegotiationneeded = async () => {
    try{
      const senders = _pc.getSenders();
      for(const s of senders){
        if(s.track && s.track.kind === 'video' && s.setParameters){
          const p = s.getParameters();
          if(!p.encodings || p.encodings.length === 0) p.encodings = [{}];
          // set moderate max bitrate ‚Äî browser may ignore if unsupported
          p.encodings[0].maxBitrate = 600 * 1000; // 600 kbps
          await s.setParameters(p).catch(()=>{});
        }
      }
    }catch(e){ console.warn('setParameters failed', e); }
  };

  return _pc;
}

/* =============== host flow =============== */
hostBtn.addEventListener('click', async ()=>{
  try{
    roomId = pinInput.value.trim();
    if(!roomId){ alert('Enter room id (1008)'); return; }
    isHost = true;

    // check if room exists
    const metaSnap = await db.ref('rooms/'+roomId+'/meta').get();
    if(metaSnap.exists()){
      alert('Room already exists. If you want to join, use Join.');
      return;
    }

    await startLocalMedia('user');
    pc = createPeerConnection();

    roomRef = db.ref('rooms/'+roomId);
    await roomRef.child('meta').set({ host: true, createdAt: Date.now() });

    // listen chat immediately
    listenChat();

    // answer listener (guest will set answer)
    const ansRef = roomRef.child('answer');
    const ansHandler = ansRef.on('value', async snap=>{
      const ans = snap.val();
      if(ans && pc && pc.signalingState !== 'closed'){
        try{ await pc.setRemoteDescription(new RTCSessionDescription(ans)); console.log('Host set remote answer'); }catch(e){ console.warn(e); }
      }
    });
    listenRefs.push({ref: ansRef, handler: ansHandler});

    // listen guest candidates
    const candRef = roomRef.child('candidates');
    const candHandler = candRef.on('child_added', async snap=>{
      const val = snap.val();
      if(val && val.from === 'guest' && val.candidate){
        try{ await pc.addIceCandidate(val.candidate); }catch(e){ console.warn('addIce err', e); }
      }
    });
    listenRefs.push({ref: candRef, handler: candHandler});

    // create offer
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await roomRef.child('offer').set(offer.toJSON());

    roomLinkInput.value = makeRoomLink(roomId);
    alert('Room created. Share link or tell guest to open the same URL. PIN = ' + roomId);
  }catch(err){
    console.error('Host error', err); alert('Error creating room: ' + (err.message||err));
  }
});

/* =============== join flow =============== */
joinBtn.addEventListener('click', async ()=>{
  try{
    roomId = pinInput.value.trim();
    if(!roomId){ alert('Enter room id (1008)'); return; }

    roomRef = db.ref('rooms/'+roomId);
    const metaSnap = await roomRef.child('meta').get();
    if(!metaSnap.exists()){ alert('Room not found. Ask host to create the room first.'); return; }

    // check if guest already joined
    const guestSnap = await roomRef.child('meta/guestJoined').get();
    if(guestSnap.exists() && guestSnap.val() === true){ alert('Room already full.'); return; }

    await startLocalMedia('user');
    pc = createPeerConnection();

    // read offer
    const offerSnap = await roomRef.child('offer').get();
    if(!offerSnap.exists()){ alert('Offer not available yet. Host may not have created offer.'); return; }
    const offer = offerSnap.val();
    await pc.setRemoteDescription(new RTCSessionDescription(offer));

    // create answer
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await roomRef.child('answer').set(answer.toJSON());

    // mark guest joined
    await roomRef.child('meta/guestJoined').set(true);

    // listen host candidates
    const candRef = roomRef.child('candidates');
    const candHandler = candRef.on('child_added', async snap=>{
      const val = snap.val();
      if(val && val.from === 'host' && val.candidate){
        try{ await pc.addIceCandidate(val.candidate); }catch(e){ console.warn('addIce err', e); }
      }
    });
    listenRefs.push({ref: candRef, handler: candHandler});

    listenChat();
    roomLinkInput.value = makeRoomLink(roomId);
    alert('Joined room. Connecting...');
  }catch(err){
    console.error('Join error', err); alert('Error joining: ' + (err.message||err));
  }
});

/* =============== chat =============== */
function listenChat(){
  if(!roomRef) return;
  const chatRef = roomRef.child('chat');
  const handler = chatRef.on('child_added', snap=>{
    const val = snap.val();
    if(!val) return;
    const mine = (val.sender === (isHost ? 'host' : 'guest'));
    if(val.type === 'text') addMessage(val.content, mine);
    else if(val.type === 'file') addMessage(val.data, mine, val.fileType);
  });
  listenRefs.push({ref: chatRef, handler});
}
async function sendChat(){
  const txt = textInput.value.trim();
  const f = fileInput.files[0];
  if(txt){
    const obj = { type:'text', content: txt, sender: isHost? 'host':'guest', ts: Date.now() };
    await roomRef.child('chat').push(obj);
    addMessage(txt, true);
    textInput.value = '';
  }
  if(f){
    const MAX = 6*1024*1024;
    if(f.size > MAX){ alert('File too large (max 6MB)'); return; }
    const reader = new FileReader();
    reader.onload = async ()=> {
      const dataUrl = reader.result;
      const obj = { type:'file', data: dataUrl, fileType: f.type, sender: isHost? 'host':'guest', ts: Date.now() };
      await roomRef.child('chat').push(obj);
      addMessage(dataUrl, true, f.type);
    };
    reader.readAsDataURL(f);
    fileInput.value = '';
  }
}
sendBtn.addEventListener('click', sendChat);
textInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendChat(); });

/* =============== controls =============== */
muteBtn.addEventListener('click', ()=>{
  if(!localStream) return;
  muted = !muted;
  localStream.getAudioTracks().forEach(t => t.enabled = !muted);
  muteBtn.textContent = muted ? 'üîá Unmute' : 'üé§ Mute';
});
switchBtn.addEventListener('click', async ()=>{
  if(!localStream) return;
  const track = localStream.getVideoTracks()[0];
  const cur = (track.getSettings && track.getSettings().facingMode) || facing;
  const newFacing = cur === 'user' ? 'environment' : 'user';
  localStream.getTracks().forEach(t=>t.stop());
  facing = newFacing;
  await startLocalMedia(facing);
  if(pc){
    const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
    if(sender && localStream.getVideoTracks()[0]) sender.replaceTrack(localStream.getVideoTracks()[0]);
  }
});
speakerBtn.addEventListener('click', ()=> {
  speakerOn = !speakerOn;
  remoteVideo.muted = !speakerOn;
  speakerBtn.textContent = speakerOn ? 'üîä Speaker' : 'üîà Off';
});
endBtn.addEventListener('click', async ()=>{
  try{ if(pc) pc.close(); }catch(e){}
  try{ if(localStream) localStream.getTracks().forEach(t=>t.stop()); }catch(e){}
  // cleanup DB only if host (removes room)
  if(isHost && roomRef){
    try{ await roomRef.remove(); }catch(e){ console.warn('room remove failed', e); }
  } else if(roomRef){
    try{ await roomRef.child('meta/guestJoined').remove(); }catch(e){}
  }
  // remove listeners
  listenRefs.forEach(o=> { try{ if(o.ref && o.handler) o.ref.off('child_added', o.handler); }catch(e){} });
  setTimeout(()=> location.reload(),200);
});

/* =============== PIP swap & drag =============== */
localVideo.addEventListener('click', ()=>{
  const isMin = localVideo.classList.contains('min');
  if(isMin){ localVideo.classList.remove('min'); remoteVideo.classList.remove('small'); }
  else{ localVideo.classList.add('min'); remoteVideo.classList.add('small'); }
});
remoteVideo.addEventListener('click', ()=>{
  const isSmall = remoteVideo.classList.contains('small');
  if(isSmall){ remoteVideo.classList.remove('small'); localVideo.classList.remove('min'); }
  else{ remoteVideo.classList.add('small'); localVideo.classList.add('min'); }
});
let dragging=false, offX=0, offY=0;
localVideo.addEventListener('pointerdown', e=>{
  dragging=true; localVideo.setPointerCapture(e.pointerId);
  const r = localVideo.getBoundingClientRect();
  offX = e.clientX - r.left; offY = e.clientY - r.top;
});
window.addEventListener('pointermove', e=>{
  if(!dragging) return;
  const x = e.clientX - offX, y = e.clientY - offY;
  const pad=8;
  const maxX = window.innerWidth - localVideo.offsetWidth - pad;
  const maxY = window.innerHeight - localVideo.offsetHeight - pad;
  localVideo.style.left = Math.max(pad, Math.min(maxX, x)) + 'px';
  localVideo.style.top = Math.max(pad+60, Math.min(maxY, y)) + 'px';
});
window.addEventListener('pointerup', ()=>dragging=false);

/* =============== watch offer (guest fallback) =============== */
async function watchOfferAndAutoAnswer(){
  if(!roomRef) return;
  const offerRef = roomRef.child('offer');
  const handler = offerRef.on('value', async snap=>{
    const offer = snap.val();
    if(offer && !isHost && pc){
      try{
        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await roomRef.child('answer').set(answer.toJSON());
        await roomRef.child('meta/guestJoined').set(true);
      }catch(e){ console.warn('watchOffer error', e); }
    }
  });
  listenRefs.push({ref: offerRef, handler});
}

/* =============== copy link =============== */
copyLinkBtn.addEventListener('click', ()=>{
  if(roomLinkInput.value) navigator.clipboard.writeText(roomLinkInput.value).then(()=> {
    copyLinkBtn.textContent='Copied';
    setTimeout(()=> copyLinkBtn.textContent='Copy Link',1200);
  });
});

/* =============== init from URL =============== */
(function initFromUrl(){
  const r = extractRoomFromPath();
  if(r){
    pinInput.value = r;
    roomLinkInput.value = makeRoomLink(r);
  }
})();

/* =============== cleanup on unload =============== */
window.addEventListener('beforeunload', async ()=>{
  try{ if(!isHost && roomRef) await roomRef.child('meta/guestJoined').remove(); }catch(e){}
});

</script>
</body>
  </html>
